rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Rules for the 'users' collection
    match /users {
      // Allow any authenticated user to get the list of all users.
      // This is required for the chat feature to search for users.
      allow list: if request.auth != null;
    }

    // Rules for a single document within the 'users' collection
    match /users/{userId} {
      // Allow anyone to create a user document during signup.
      // This is secure because the 'update' rule prevents others from changing it.
      allow create: if true;

      // Only the user themselves can read or update their own profile.
      allow get, update: if request.auth != null && request.auth.uid == userId;
    }

    // Rules for the 'chats' collection
    match /chats/{chatId} {
      // A user can get, create, or update a chat only if they are a participant.
      allow get, create, update: if request.auth != null && request.auth.uid in resource.data.participants;
      
      // A user can only see chats they are a part of.
      allow list: if request.auth != null && request.auth.uid in resource.data.participants;

      // Rules for messages within a chat
      match /messages/{messageId} {
        // A user can read or write messages only in chats they are a participant of.
        allow read, write: if request.auth != null && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      }
    }
  }
}
