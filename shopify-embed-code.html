<!-- SnazzPay Secure COD Button Start -->
<!-- 
  IMPORTANT: Before pasting this into Shopify, you MUST replace 'YOUR_APP_URL' below
  with your actual live application URL. For example: https://my-cool-store.vercel.app
-->
<div id="snazzpay-secure-cod-container">
    <form id="snazzpay-secure-cod-form" action="YOUR_APP_URL/secure-cod" method="GET" target="_blank" style="margin-top: 15px; width: 100%;">
        <!-- Hidden fields for product data -->
        <input type="hidden" name="name" id="snazzpay-p-name" />
        <input type="hidden" name="amount" id="snazzpay-p-amount" />
        <input type="hidden" name="image" id="snazzpay-p-image" />
        <input type="hidden" name="order_id" id="snazzpay-p-order-id" />
        <input type="hidden" name="sellerName" id="snazzpay-p-sellerName" />
        <input type="hidden" name="sellerId" id="snazzpay-p-sellerId" />
        <input type="hidden" name="sizes" id="snazzpay-p-sizes" />
        <input type="hidden" name="colors" id="snazzpay-p-colors" />
        <input type="hidden" name="productId" id="snazzpay-p-productId" />
        <input type="hidden" name="vendor" id="snazzpay-p-vendor" />
        <input type="hidden" name="collection" id="snazzpay-p-collection" />

        <button 
            type="submit" 
            style="width: 100%; min-height: 45px; font-size: 16px; background-color: #5a31f4; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s;"
            onmouseover="this.style.backgroundColor='#4a28c7'"
            onmouseout="this.style.backgroundColor='#5a31f4'"
        >
            Buy with Secure COD
        </button>
        <div style="text-align: center; margin-top: 8px; font-size: 12px;">
            <a href="YOUR_APP_URL/secure-cod-info" target="_blank" style="color: #5a31f4; text-decoration: underline;">What is this?</a>
        </div>
    </form>
</div>

<!-- Data script to safely pass Liquid variables to JavaScript -->
<script id="snazzpay-product-data" type="application/json">
{
  "id": {{ product.id | json }},
  "vendor": {{ product.vendor | json }},
  "type": {{ product.type | json }},
  "title": {{ product.title | json }},
  "featuredImage": {{ product.featured_image | img_url: 'large' | json }},
  "initialVariant": {{ product.selected_or_first_available_variant | json }},
  "options_with_values": {{ product.options_with_values | json }}
}
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        const container = document.getElementById('snazzpay-secure-cod-container');
        if (!container) return;

        const dataScript = document.getElementById('snazzpay-product-data');
        if (!dataScript || !dataScript.textContent) {
          console.error("SnazzPay Error: Data script not found or empty.");
          container.style.display = 'none';
          return;
        }

        const productData = JSON.parse(dataScript.textContent);
        const vendor = productData.vendor;

        // --- Vendor Visibility Logic ---
        const allowedVendors = [
            'Ashish', 'Deep Sarees', 'Elite', 'Haryana Garments', 'Indie Glam', 
            'Lace Collections', 'Luv Kush creations', 'Sakshi Indiedrop', 'Shipera', 
            'Snazzify AI', 'Snazzify RC', 'snazzify.co.in', 'Snazzify.co.in', 
            'sneaker room', 'SR', 'Taufiq Khan', 'Wukusy'
        ];
        
        if (vendor && !allowedVendors.includes(vendor)) {
            container.style.display = 'none';
            return; 
        }
        // --- End of Vendor Logic ---

        const form = document.getElementById('snazzpay-secure-cod-form');
        const nameInput = document.getElementById('snazzpay-p-name');
        const amountInput = document.getElementById('snazzpay-p-amount');
        const imageInput = document.getElementById('snazzpay-p-image');
        const orderIdInput = document.getElementById('snazzpay-p-order-id');
        const sellerNameInput = document.getElementById('snazzpay-p-sellerName');
        const sellerIdInput = document.getElementById('snazzpay-p-sellerId');
        const sizesInput = document.getElementById('snazzpay-p-sizes');
        const colorsInput = document.getElementById('snazzpay-p-colors');
        const productIdInput = document.getElementById('snazzpay-p-productId');
        const vendorInput = document.getElementById('snazzpay-p-vendor');
        const collectionInput = document.getElementById('snazzpay-p-collection');


        function updateForm(variant) {
            const currentVariant = variant || productData.initialVariant;
            if (!currentVariant) {
                console.error("SnazzPay Error: Could not determine product variant.");
                return;
            }

            nameInput.value = productData.title;
            amountInput.value = (currentVariant.price / 100).toFixed(2);
            imageInput.value = currentVariant.featured_image ? currentVariant.featured_image.src : productData.featuredImage;
            orderIdInput.value = 'SNZ-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5).toUpperCase();
            
            // Pass all relevant data
            sellerNameInput.value = productData.vendor || '';
            sellerIdInput.value = productData.vendor || ''; // Using vendor name as ID for simplicity
            productIdInput.value = productData.id;
            vendorInput.value = productData.vendor;
            collectionInput.value = productData.type;


            const sizes = productData.options_with_values.find(opt => opt.name.toLowerCase() === 'size')?.values || [];
            const colors = productData.options_with_values.find(opt => opt.name.toLowerCase() === 'color')?.values || [];
            
            if (sizesInput) sizesInput.value = sizes.join(',');
            if (colorsInput) colorsInput.value = colors.join(',');
        }

        updateForm();

        document.addEventListener('variant:change', function(event) {
            if (event.detail.variant) {
                updateForm(event.detail.variant);
            }
        });

    } catch (e) {
        console.error("SnazzPay Script Error:", e);
        const container = document.getElementById('snazzpay-secure-cod-container');
        if (container) container.style.display = 'none';
    }
});
</script>
<!-- SnazzPay Secure COD Button End -->
