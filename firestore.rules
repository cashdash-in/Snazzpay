
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // USERS COLLECTION
    // This rule allows the creation of a user document, which is necessary for both signup and admin approval.
    // Security is maintained because once created, only the user themselves can update their document.
    match /users/{userId} {
      allow create; // Allow document creation
      allow list, get: if request.auth != null; // Any authenticated user can read user list for chat
      allow update: if request.auth != null && request.auth.uid == userId; // Only owner can update
      allow delete: if false; // Prevent deletion
    }

    // CHATS COLLECTION
    // This secures the chat functionality.
    match /chats/{chatId} {
      // Allow read/write only if the user is a participant in the chat.
      allow read, write: if request.auth != null && request.auth.uid in resource.data.participants;

      // MESSAGES SUBCOLLECTION
      // This secures the messages within a chat.
      match /messages/{messageId} {
        // Allow read/write only if the user is a participant in the parent chat document.
        allow read, write: if request.auth != null && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      }
    }
  }
}
