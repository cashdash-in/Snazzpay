rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Default deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // Allow any authenticated user to read from any collection.
    // This is necessary for dashboards and list views to function.
    match /{path=**} {
      allow get, list: if request.auth != null;
    }

    // Allow users to create and manage their own specific documents.
    // This covers signup and individual settings.
    match /seller_users/{userId} {
      allow create, read, update, delete: if request.auth != null && request.auth.uid == userId;
    }
    match /vendors/{userId} {
      allow create, read, update, delete: if request.auth != null && request.auth.uid == userId;
    }
     match /user_permissions/{userId} {
      allow create, read, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Allow any authenticated user to create documents in these collections.
    // This is needed for creating orders, leads, drops, etc. from the app.
    // Read access is already granted by the wildcard rule above.
    // Update/delete should be handled with more granular rules if needed.
    match /orders/{orderId} {
      allow create, update: if request.auth != null;
    }
    match /leads/{leadId} {
      allow create, update, delete: if request.auth != null;
    }
    match /product_drops/{dropId} {
       allow create, update, delete: if request.auth != null;
    }
     match /seller_products/{productId} {
       allow create, update, delete: if request.auth != null;
    }
    match /vendor_orders/{orderId} {
        allow create, update, delete: if request.auth != null;
    }
     match /shakti_cards/{cardId} {
        allow create, update: if request.auth != null;
    }
    match /payment_info/{paymentId} {
        allow create, update: if request.auth != null;
    }

    // Rules for chat functionality
    match /chats/{chatId} {
      allow read, create, update: if request.auth != null && request.auth.uid in resource.data.participants;
      
      match /messages/{messageId} {
        allow read, create: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
  }
}